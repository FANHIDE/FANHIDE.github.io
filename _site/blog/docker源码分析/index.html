<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Yunfan Zhang" />
    <meta name="description" content="Personal website and resume">
    <link rel="shortcut icon" type="image/x-icon" href="https://fanhide.github.io/img/favicon.ico">
    <title>docker源码分析</title>
    <meta name="generator" content="Hugo 0.55.6" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fanhide.github.io/css/main.css" /><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/tomorrow.min.css">
    
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,400,200bold,400old" />
    
    <!--[if lt IE 9]>
			<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
			<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
		<![endif]-->

    
  </head>

  <body>
    <div id="wrap">

      
      <nav class="navbar navbar-default">
  <div class="container">
    <div class="navbar-header">
      <a class="navbar-brand" href="https://fanhide.github.io/"><i class="fa fa-home"></i></a>
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <div class="navbar-collapse collapse" id="navbar">
      <ul class="nav navbar-nav navbar-right">
      
        
        <li><a href="/blog/">BLOG</a></li>
        
        <li><a href="/projects/">PROJECTS</a></li>
        
        <li><a href="/resume/">RESUME</a></li>
        
      
      </ul>
    </div>
  </div>
</nav>

      
      <div class="container">
        <div class="blog-post">
          <h3>
            <strong><a href="https://fanhide.github.io/blog/docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">docker源码分析</a></strong>
          </h3>
        </div>
        <div class="blog-title">
          <h4>
          August 17, 2019
            &nbsp;&nbsp;
            
            <span class="label label-success">Docker</span>
            
            <span class="label label-success">Docker client</span>
            
            <span class="label label-success">Docker daemon</span>
            
          </h4>
        </div>
        <div class="panel panel-default">
          <div class="panel-body">
            <div class="blogpost">
              

<h3 id="docker-cli">docker cli</h3>

<h4 id="数据结构">数据结构</h4>

<pre><code class="language-go">// DockerCli结构
type DockerCli struct {
	proto      string		// (Client和Server直接的传输类型)协议类型 tcp、unix、fd
	addr       string		// Docker需要访问host的目标
	configFile *registry.ConfigFile // for what ?
	in         io.ReadCloser	// 读和关闭接口
	out        io.Writer            // 写接口
	err        io.Writer		// 错误输出接口
	isTerminal bool			// 终端相关？
	terminalFd uintptr		// 文件句柄
	tlsConfig  *tls.Config		// tls配置
	scheme     string		// 指示http或者https
}
</code></pre>

<h4 id="结构体包含的方法">结构体包含的方法</h4>

<pre><code class="language-go">// 创建DockerCli对象。(工厂模式)
func NewDockerCli(in io.ReadCloser, out, err io.Writer, proto, addr string, tlsConfig *tls.Config) *DockerCli {
	var (
		isTerminal = false
		terminalFd uintptr
		scheme     = &quot;http&quot;
	)

	// 如果有tls配置那么使用https协议。
	if tlsConfig != nil {
		scheme = &quot;https&quot;
	}
	// 如果输入不是nil，同时输出可以转化为文件类型，那么获取文件句柄，同时判断是否为终端类型。
	if in != nil {
		if file, ok := out.(*os.File); ok {
			terminalFd = file.Fd()				// 获取文件句柄
			isTerminal = term.IsTerminal(terminalFd)	// 判断是否为终端类型,实现在docker/pkg/term/term.go
		}
	}

	// 如果没有指定错误输出，那么输出作为错误输出。
	if err == nil {
		err = out
	}
	// 通过之前的参数处理创建DdockerCli对象。
	return &amp;DockerCli{
		proto:      proto,
		addr:       addr,
		in:         in,
		out:        out,
		err:        err,
		isTerminal: isTerminal,
		terminalFd: terminalFd,
		tlsConfig:  tlsConfig,
		scheme:     scheme,
	}
}

</code></pre>

<pre><code class="language-go">//获取method，利用反射的value特性中的methordByName,判断method是否存在，如果存在的话，返回method的interface的方法
func (cli *DockerCli) getMethod(name string) (func(...string) error, bool) {
	if len(name) == 0 {
		return nil, false
	}
	methodName := &quot;Cmd&quot; + strings.ToUpper(name[:1]) + strings.ToLower(name[1:])
	method := reflect.ValueOf(cli).MethodByName(methodName)
	if !method.IsValid() {
		return nil, false
	}
	return method.Interface().(func(...string) error), true
}
</code></pre>

<pre><code class="language-go">// 执行命令
func (cli *DockerCli) Cmd(args ...string) error {
	if len(args) &gt; 0 {
		// 有请求信息
		method, exists := cli.getMethod(args[0])
		if !exists {
			// 请求信息的方法不存在则输出help信息
			fmt.Println(&quot;Error: Command not found:&quot;, args[0])
			return cli.CmdHelp(args[1:]...)
		}
		// 方法存在就调用相应的方法并返回结果
		return method(args[1:]...)
	}
	// 没有请求信息则输出help信息
	return cli.CmdHelp(args...)
}
</code></pre>

<pre><code class="language-go">//subcmd:定义一个类型为flagset的cmd.
func (cli *DockerCli) Subcmd(name, signature, description string) *flag.FlagSet {
	flags := flag.NewFlagSet(name, flag.ContinueOnError)
	flags.Usage = func() {
		fmt.Fprintf(cli.err, &quot;\nUsage: docker %s %s\n\n%s\n\n&quot;, name, signature, description)
		flags.PrintDefaults()
		os.Exit(2)
	}
	return flags
}
</code></pre>

<pre><code class="language-go">//获取配置文件
func (cli *DockerCli) LoadConfigFile() (err error) {
	cli.configFile, err = registry.LoadConfig(os.Getenv(&quot;HOME&quot;))
	if err != nil {
		fmt.Fprintf(cli.err, &quot;WARNING: %s\n&quot;, err)
	}
	return err
}
</code></pre>

<pre><code class="language-go">//具体命令执行
//docker -Help -h
func (cli *DockerCli) CmdHelp(args ...string) error {...}
//docker build
func (cli *DockerCli) CmdBuild(args ...string) error {...}
//docker login
func (cli *DockerCli) CmdLogin(args ...string) error {...}
//docker logout
func (cli *DockerCli) CmdLogout(args ...string) error {...}
//docker wait
func (cli *DockerCli) CmdWait(args ...string) error {...}
//docker version
func (cli *DockerCli) CmdVersion(args ...string) error {...}
//docker info
func (cli *DockerCli) CmdInfo(args ...string) error {...}
//docker stop
func (cli *DockerCli) CmdStop(args ...string) error {...}
//docker restart 
func (cli *DockerCli) CmdRestart(args ...string) error {...}
//docker 
func (cli *DockerCli) forwardAllSignals(cid string) chan os.Signal
//docker start 
func (cli *DockerCli) CmdStart(args ...string) error
//docker unpause
func (cli *DockerCli) CmdUnpause(args ...string) error
//docker inpect
func (cli *DockerCli) CmdInspect(args ...string) error
//docker top
func (cli *DockerCli) CmdTop(args ...string) error
//docker port
func (cli *DockerCli) CmdPort(args ...string) error
//docker rmi
func (cli *DockerCli) CmdRmi(args ...string) error
//docker history
func (cli *DockerCli) CmdHistory(args ...string) error
//docker rm
func (cli *DockerCli) CmdRm(args ...string) error
//docker kill
func (cli *DockerCli) CmdKill(args ...string) error
//docker import
func (cli *DockerCli) CmdImport(args ...string) error
//docker export
func (cli *DockerCli) CmdExport(args ...string) error
//docker push
func (cli *DockerCli) CmdPush(args ...string) error
//docker pull
func (cli *DockerCli) CmdPull(args ...string) error
//docker image
func (cli *DockerCli) CmdImages(args ...string) error
//docker ps
func (cli *DockerCli) CmdPs(args ...string) error 
//docker commit
func (cli *DockerCli) CmdCommit(args ...string) error
//docker event
func (cli *DockerCli) CmdEvents(args ...string) error
//docker diff
func (cli *DockerCli) CmdDiff(args ...string) error
//docker attach
func (cli *DockerCli) CmdAttach(args ...string) error
//docker search
func (cli *DockerCli) CmdSearch(args ...string) error 
//docker tag
func (cli *DockerCli) CmdTag(args ...string) error
//docker pullimages
func (cli *DockerCli) pullImage(image string) error
//docker run
func (cli *DockerCli) CmdRun(args ...string) error
//docker cp
func (cli *DockerCli) CmdCp(args ...string) error
//docker save
func (cli *DockerCli) CmdSave(args ...string) error
//docker load
func (cli *DockerCli) CmdLoad(args ...string) error

</code></pre>

<h4 id="daemon">Daemon</h4>

<h4 id="数据结构-1">数据结构</h4>

<pre><code class="language-go">//docker daemon的config配置
type Config struct {
	Pidfile                     string
	Root                        string
	AutoRestart                 bool
	Dns                         []string
	DnsSearch                   []string
	EnableIptables              bool
	EnableIpForward             bool
	DefaultIp                   net.IP
	BridgeIface                 string
	BridgeIP                    string
	InterContainerCommunication bool
	GraphDriver                 string
	GraphOptions                []string
	ExecDriver                  string
	Mtu                         int
	DisableNetwork              bool
	EnableSelinuxSupport        bool
	Context                     map[string][]string
}
</code></pre>

<pre><code class="language-go">//engine对象，docker的运行引擎，类似docker container的存储仓库
type Engine struct {
	handlers   map[string]Handler//重要handler是一个函数类型，type Handler func(*Job) Status
	catchall   Handler
	hack       Hack // data for temporary hackery (see hack.go)
	id         string
	Stdout     io.Writer
	Stderr     io.Writer
	Stdin      io.Reader
	Logging    bool
	tasks      sync.WaitGroup
	l          sync.RWMutex // lock for shutdown
	shutdown   bool        //用于信号捕获（SIGINT、SIGTERM、SIGQUIT）
	onShutdown []func() // shutdown handlers
}
//type Status int
//const (
//  StatusOk Status = 1
//  StatusErr Status = 0
//  StatusNotFound Status = 127)	
</code></pre>

<pre><code class="language-go">//初始化
func New() *Engine {
	eng := &amp;Engine{
		handlers: make(map[string]Handler),
		id:       utils.RandomString(),
		Stdout:   os.Stdout,
		Stderr:   os.Stderr,
		Stdin:    os.Stdin,
		Logging:  true,
	}
	eng.Register(&quot;commands&quot;, func(job *Job) Status {
		for _, name := range eng.commands() {
			job.Printf(&quot;%s\n&quot;, name)
		}
		return StatusOK
	})
	// Copy existing global handlers
	for k, v := range globalHandlers {
		eng.handlers[k] = v
	}
	return eng
}
</code></pre>

<pre><code class="language-go">//job与engine绑定
type Job struct {
	Eng     *Engine        //通过*Engine与engine绑定
	Name    string         //job名
	Args    []string
	env     *Env
	Stdout  *Output
	Stderr  *Output
	Stdin   *Input
	handler Handler
	status  Status
	end     time.Time
}
</code></pre>

              <hr>
              <div class="related-posts">
                <h5>Related Posts</h5>
                
              </div>
            </div>
          </div>
          <hr>
        <div class="disqus">
  <div id="disqus_thread"></div>
  <script type="text/javascript">

    (function() {
      
      
      if (window.location.hostname == "localhost")
        return;

      var disqus_shortname = '';
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
        </div>
      </div>
      
    </div>

    
    <footer>
  <div id="footer">
    <div class="container">
      <p class="text-muted">&copy; All rights reserved. Powered by <a href="https://gohugo.io/">Hugo</a> and
      <a href="http://www.github.com/nurlansu/hugo-sustain/">sustain</a> with ♥</p>
    </div>
  </div>
</footer>
<div class="footer"></div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://fanhide.github.io/js/docs.min.js"></script>
<script src="https://fanhide.github.io/js/main.js"></script>

<script src="https://fanhide.github.io/js/ie10-viewport-bug-workaround.js"></script><!-- Syntax highlighting -->
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



    
  </body>
</html>
